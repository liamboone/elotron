{% extends "base.html" %}

{% block title %}
    {{ users[uname] }} {% if uname != '' %} - {% endif %}
{% endblock %}

{% block user_menu %}
    {% for user in users|dictsort(false, 'value') %}
    <li><a href='/{{user[0]}}'>{{user[1]}}</a></li>
    {% endfor %}
{% endblock %}

{% block user_content %}
    {% set new_player_found = [] %}
    {{super()}}
    <h3>Leaderboard</h3>
    <div class="list-group">
        {% for rank, user, num_games in leaderboard %}
        <a href="/{{user}}"
            class="list-group-item {% if user == uname %}active{% endif %}">
            <span class="badge">{{ rank|round|int }}</span>
            {{ users[user] }}
            {% if num_games < new_player_period %}
            {% if new_player_found.append(1) %}{% endif %}
            {# jinja scoping is odd. The above gets around some rules #}
            {# so we can detect if there are any new players and #}
            {# display the footnote #}
                *
            {% endif %}
        </a>
        {% endfor %}
    </div>
    {% if uname != "" and ranks[uname] < leaderboard[-1][0] %}
    <div style="text-align:center;"><h4>â‹®</h4></div><br />
    <div class="list-group">
        <a href="/{{uname}}"
            class="list-group-item active">
            <span class="badge">{{ ranks[uname]|round|int }}</span>
            {{ users[uname] }}
        </a>
    </div>
    {% endif %}
    {% if new_player_found %}
    <p><small>
    * Played less than {{new_player_period}} games.
    </small></p>
    {% endif %}
{% endblock %}

{% block match_content %}
{{super()}}
    {% for m, match in enumerate(matches) %}
    <div id="match" class="panel panel-default">
        <div id="participants" class="panel-body">
            {% if uname != '' %}
            <div style="float:left" class="right-divider">
                {% if differential[m][uname][0] < 0 %}
                <span class="badge alert-danger">
                {{ differential[m][uname][1]|int }}
                    <span class="glyphicon glyphicon-arrow-down">
                    </span>
                {% elif differential[m][uname][0] > 0 %}
                <span class="badge alert-success">
                {{ differential[m][uname][1]|int }}
                    <span class="glyphicon glyphicon-arrow-up">
                    </span>
                {% else %}
                <span class="badge">
                {{ differential[m][uname][1]|int }}
                {% endif %}
                {{ differential[m][uname][0]|abs|int }}
                </span>
            </div>
            {% endif %}
            <div style="float:left">
                    {% for i, player in enumerate(match.participants) %}
                    {% if i != 0 %}<small> vs </small>{% endif %}
                    <a href="/{{player[0]}}" 
                        style="text-decoration:none;">
                            <b>{{ users[player[0]] }}</b>
                            {% if i == match.winner %}
                            <span class="badge alert-info">
                            {% else %}
                            <span class="badge">
                            {% endif %}
                            {{ player[1] }}
                            </span>
                    </a>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endfor %}
{% endblock %}

{% block add_match %}
    <script>
    var postMatch = function ()
    {
        var match_str = document.getElementById("player1").value + ";" +
                        document.getElementById("score1").value + ";" +
                        document.getElementById("player2").value + ";" +
                        document.getElementById("score2").value;
        var match_b64 = btoa(match_str).replace('/','_').replace('+','.');
        {% if admin %}
        match_b64 += "?month=" + document.getElementById("month").value + 
                     "&day="   + document.getElementById("day").value
        {% endif %}
        d3.json("/add_match/"+match_b64, function(error, data) {
                    if (error) return console.warn(error);
                    loopback = data;
                    console.log(data);
                    if (data.error.length == 0)
                    {
                        document.getElementById("score1").value = "";
                        document.getElementById("score2").value = "";
                        window.location.reload();
                    }
                    else
                    {
                        document.querySelector("#player1-form-group")
                            .classList.remove("has-error");
                        document.querySelector("#player2-form-group")
                            .classList.remove("has-error");
                        document.querySelector("#score1-form-group")
                            .classList.remove("has-error");
                        document.querySelector("#score2-form-group")
                            .classList.remove("has-error");

                        var previous_msgs = document
                            .getElementsByClassName("alert");
                        while(previous_msgs[0])
                        {
                            previous_msgs[0].parentElement.removeChild(previous_msgs[0])
                        }

                        var inputs = document.getElementById("match_inputs");

                        for (var i = 0; i < data.error.length; ++i)
                        {
                            err = data.error[i];
                            for (var j = 0; j < err[0].length; ++j)
                            {
                                document
                                    .querySelector("#"+err[0][j]+"-form-group")
                                    .classList.add("has-error");
                            }
                            var err_msg = document.createElement("div");
                            err_msg.classList.add("alert");
                            err_msg.classList.add("alert-danger");
                            err_msg.classList.add("alert-dismissable");
                            err_msg.innerHTML = "<button type=\"button\" class=\"close\" data-dismiss=\"alert\"><span aria-hidden=\"true\">&times;</span><span class=\"sr-only\">Close</span></button><strong>Error:</strong> "+err[1];
                            inputs.appendChild(err_msg);
                        }
                    }
                });
    };
    </script>
    <form id="add_match" class="form-inline" role="form">
        <div id="match_inputs">
            {% for player in [1,2] %}
            <div id="player{{player}}-form-group" class="form-group">
                <select id="player{{player}}" class="form-control form-control-danger">
                    {% for user in users|dictsort(false, 'value') %}
                    <option 
                        {% if player == 1 and uname == user[0] %}
                            selected="selected"
                        {% endif %}
                            value="{{user[0]}}">
                        {{user[1]}}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div id="score{{player}}-form-group" class="form-group has-feedback">
                <input id="score{{player}}" class="form-control" placeholder="score">
            </div>
            <br />
            <br />
            {% endfor %}
        </div>
        {% if admin %}
        <div id="month-day-form-group" class="form-group">
            <input id="month" class="form-control" placeholder="month">
            <input id="day" class="form-control" placeholder="day">
        </div>
        {% endif %}
        <input onclick="postMatch();" type="button" 
            class="btn btn-primary" value="Add Match">
    </form>
{% endblock %}

{% block stats_content %}
{% if uname != '' %}
    <div id="chart-timeline" style=""></div>
    <div id="chart-opponents" style="float:right"><div style="position:absolute;top:315px;padding-left:75px;text-align:center">Number of Games<br/>Against Each Opponent</div></div>

    <div id="chart-pointsTaken" style="margin: 30px 5px 10px 10px"></div>
    <div id="chart-winsLosses" style="margin: 30px 15px 10px 0px"></div>
    <div id="chart-pointsTakenElo" style="margin: 30px 0px 10px 30px"></div>

    <div style="clear:both;padding:50px">
        <table id="dc-data-table">
            <thead>
                <tr class="header">
                    <th>Day</th>
                    <th>Your rating</th>
                    <th>Your score</th>
                    <th>Opponent's score</th>
                    <th>Opponent's rating</th>
                </tr>
            </thead>
        </table>
    </div>
    <script>
    /*  FIX for brush filtering on composite chart, from: https://groups.google.com/forum/#!topic/dc-js-user-group/yI6_cbvgfbU  */
    (function() {
        var compositeChart = dc.compositeChart;
        dc.compositeChart = function(parent, chartGroup) {
            var _chart = compositeChart(parent, chartGroup);
            
            _chart._brushing = function () {
                var extent = _chart.extendBrush();
                var rangedFilter = null;
                if(!_chart.brushIsEmpty(extent)) {
                    rangedFilter = dc.filters.RangedFilter(extent[0], extent[1]);
                }

                dc.events.trigger(function () {
                    if (!rangedFilter) {
                        _chart.filter(null);
                    } else {
                        _chart.replaceFilter(rangedFilter);
                    }
                    _chart.redrawGroup();
                }, dc.constants.EVENT_DELAY);
            };
            
            return _chart;
        };
    })();
    /*  END fix for brush filtering composite charts */

    /* custom functions for crossfilter reducing by average */
    function reduceAddAvg(attr) {
      return function(p,v) {
        ++p.count
        p.sum += v[attr];
        p.avg = p.sum/p.count;
        return p;
      };
    }
    function reduceRemoveAvg(attr) {
      return function(p,v) {
        --p.count
        p.sum -= v[attr];
        p.avg = p.sum/p.count;
        return p;
      };
    }
    function reduceInitAvg() {
      return {count:0, sum:0, avg:0};
    }

    /* custom functions for crossfilter reducing by point differential against elo ratings */
    function diffAdd() {
      return function(p,v) {
        p.diff = v.diff;
        p.player1elo = v.player1elo;
        p.player2elo = v.player2elo;
        return p;
      };
    }
    function diffRemove(attr) {
      return function(p,v) {
        p.diff = v.diff;
        p.player1elo = 0;
        p.player2elo = 0;
        return p;
      };
    }
    function diffInit() {
      return {diff:0,player1elo:0, player2elo:0};
    }

    /*  END custom functions for reducing */

    var data = [
        {date: "12/25/2012T12:00:00", player1: "Mike", player2: "Kyle", player1elo: 1200, player2elo: 950, player1score: 21, player2score: 19},
        {date: "12/25/2012T12:00:10", player1: "Mike", player2: "Pavan", player1elo: 1050, player2elo: 800, player1score: 21, player2score: 17},
        {date: "12/25/2012T12:00:20", player1: "Mike", player2: "Liam", player1elo: 1111, player2elo: 950, player1score: 18, player2score: 21},
        {date: "12/28/2012T05:00:10", player1: "Mike", player2: "Kirk", player1elo: 1100, player2elo: 1050, player1score: 21, player2score: 23},
        {date: "12/29/2012T06:00:10", player1: "Mike", player2: "Liam", player1elo: 950, player2elo: 1100, player1score: 21, player2score: 17},
        {date: "12/30/2012T12:00:10", player1: "Mike", player2: "John", player1elo: 900, player2elo: 950, player1score: 3, player2score: 21},
        {date: "12/31/2012T12:00:10", player1: "Mike", player2: "Liam", player1elo: 850, player2elo: 1000, player1score: 21, player2score: 17},
        {date: "1/5/2013T12:00:10", player1: "Mike", player2: "Kyle", player1elo: 975, player2elo: 950, player1score: 14, player2score: 21},
        {date: "1/7/2013T12:00:10", player1: "Mike", player2: "Liam", player1elo: 1175, player2elo: 750, player1score: 21, player2score: 13},
        {date: "1/8/2013T03:00:10", player1: "Mike", player2: "Kyle", player1elo: 1055, player2elo: 800, player1score: 15, player2score: 21},
        {date: "1/9/2013T07:00:10", player1: "Mike", player2: "John", player1elo: 850, player2elo: 950, player1score: 2, player2score: 21},
        {date: "1/10/2013T04:00:10", player1: "Mike", player2: "Kyle", player1elo: 1050, player2elo: 950, player1score: 21, player2score: 17},
    ];
    var mike_best_chart = function(error, data)
    {
    var pong = crossfilter(data);
    var all = pong.groupAll();
    var parseDate = d3.time.format("%m/%d/%YT%H:%M:%S").parse;
    var cumulWins = 0;
    var cumulLosses = 0;
    data.forEach(function(d) {
        d.date = parseDate(d.date);
        d.diff = d.player1score - d.player2score;
        if (d.player1score > d.player2score) {
            d.win = "Wins";
            cumulWins += 1;
        } else {
            d.win = "Losses";
            cumulLosses = cumulLosses - 1;
        }
        d.cumulWin = cumulWins;
        d.cumulLoss = cumulLosses;

    })

    var dateDim = pong.dimension(function(d) {return d.date;});
    var zeroGroup = dateDim.group().reduceSum(function(d) {return 0;});
    var oppDim = pong.dimension(function(d) {return d.player2;});
    var oppGroup = oppDim.group();

    /*  *** Used for cumulative points scored against each elo rating */
    var elo2Dim = pong.dimension(function(d) {return d.player2elo;});
    var scoreAgainstElo2group = elo2Dim.group().reduce(reduceAddAvg('player1score'),reduceRemoveAvg('player1score'),reduceInitAvg);


    var winDim = pong.dimension(function(d) {return d.win;});
    var winGroup = winDim.group();

    var pointsDim = pong.dimension(function(d) {return d.player1score;});
    var pointsGroup = pointsDim.group();

    //currently unused
    var pointsTakenGroup = oppDim.group().reduceSum(dc.pluck('player1score'));

    //currently unused
    var pointsGivenGroup = oppDim.group().reduceSum(dc.pluck('player2score'));

    var cumulWinsGroup = dateDim.group().reduceSum(dc.pluck('player1score'));
    var cumulLossesGroup = dateDim.group().reduceSum(dc.pluck('player2score'));
    var ret=0;
    var diffGroup = dateDim.group().reduce(diffAdd(),diffRemove(),diffInit);
    var diffPlusGroup = dateDim.group().reduceSum(function(d) {d.diff>0? ret = d.diff:ret=0; return ret});
    var diffMinusGroup = dateDim.group().reduceSum(function(d) {d.diff<0? ret = d.diff:ret=0; return ret});

    //offset necessary for the timeline graph to show all games, even at the beginning/end
    var minDate = d3.time.day.offset(dateDim.bottom(1)[0].date, -1);
    var maxDate = d3.time.day.offset(dateDim.top(1)[0].date, 1);

    timelineChart = dc.compositeChart("#chart-timeline");
    timelineChart
        .width(900).height(200)
        .dimension(dateDim)
        .y(d3.scale.linear().domain([-21,21]))
        .yAxisLabel('End-game Point Differential')
        .x(d3.time.scale().domain([minDate,maxDate]))
        .compose([
            dc.barChart(timelineChart).group(diffPlusGroup).ordinalColors(['green']).centerBar(true),
            dc.barChart(timelineChart).group(diffMinusGroup).ordinalColors(['darkred']).centerBar(true),
            dc.lineChart(timelineChart).group(zeroGroup).ordinalColors(['lightgray']),
            dc.bubbleChart(timelineChart).group(diffGroup).valueAccessor(function(d) {return d.value.diff;}).colorAccessor(function(d) {var val=1;d.value.diff<0?val=0:val=1;return val;}).colors(d3.scale.ordinal().domain(["0","1"]).range(["darkred","green"])).radiusValueAccessor(function(d) {return Math.sqrt(d.value.player2elo);}).minRadiusWithLabel(40).r(d3.scale.linear().domain([30, 150]))
            ])

    var winsLossesChart = dc.pieChart("#chart-winsLosses");
    winsLossesChart
        .width(150).height(150)
        .dimension(winDim)
        .group(winGroup)
        .colorAccessor(function(d) {return d.key})
        .colors(d3.scale.ordinal().domain(["Losses","Wins"]).range(["darkred","green"]))
        .label(function(d) {if(all.value){return d.key + " " + Math.round(d.value / all.value()*100) + '%';}});

    var opponentsChart = dc.pieChart("#chart-opponents");
    opponentsChart
        .width(300).height(300)
        .dimension(oppDim)
        .group(oppGroup)
        .label(function(d) {if(all.value){return d.key + " (" + d.value + ")"}})
        .innerRadius(30);

    /* *** for number of games in which each amount of points was achieved ***/
    var pointsTakenChart = dc.barChart("#chart-pointsTaken");
    pointsTakenChart
        .width(350).height(200)
        .dimension(pointsDim)
        .group(pointsGroup)
        .x(d3.scale.linear().domain([0,pointsDim.top(1)[0].player1score+2]))
        .centerBar(true)
        .xAxisLabel("My Points Scored in Game")
        .yAxisLabel("Number of Games")
        ;


    /* ***  for cumulative points scored against each elo rating ***/
    var pointsTaken2Chart = dc.scatterPlot("#chart-pointsTakenElo");
    pointsTaken2Chart
        .width(350).height(200)
        .dimension(elo2Dim)
        .group(scoreAgainstElo2group)
        .keyAccessor(function(d) {return d.key})
        .valueAccessor(function (d){var tempAvg=0; d.value.avg? tempAvg=d.value.avg: tempAvg=0; return tempAvg})
        .x(d3.scale.linear().domain([600,1400]))
        .y(d3.scale.linear().domain([5,22]))
        .xAxisLabel("Opponent's ELO Rating")
        .yAxisLabel("My Avg Points Scored")
        .symbolSize('5')
        .highlightedSize('7')
        ;

    var datatable = dc.dataTable("#dc-data-table");
    datatable
        .dimension(dateDim)
        .group(function (d) {return d.player2})
        .columns([
            function(d) {return d.date;},
            function(d) {return d.player1elo;},
            function(d) {return d.player1score;},
            function(d) {return d.player2score;},
            function(d) {return d.player2elo;}
            ])
        .renderlet(function (table) {
            $("#dc-data-table tr").each(function (index, Element) {
                if ($(Element).children("td").length>1) {
                    var yourScore = parseInt($(Element).children("td")[2].innerHTML);		
                    var oppScore = parseInt($(Element).children("td")[3].innerHTML);
                    $(Element).css("text-align","center");
                    if (yourScore > oppScore) {
                        $(Element).css("background-color", "lightgreen");
                    } else {
                        $(Element).css("background-color", "pink");
                    }
                }
            })
        });

    dc.renderAll();
    };
    (function() 
    {
        d3.json("/{{uname}}/stats", mike_best_chart);
    })();
    </script>
{% else %}
<div id="tooltip"></div>
<script>
var allStats = function(error, data) {
  console.log(data);
  var mpr = chordMpr(data);
  mpr
    .addValuesToMap('player1')
    .addValuesToMap('player2')
    .setFilter(function (row, a, b) {
      return (row.player1 === a.name && row.player2 === b.name) ||
             (row.player1 === b.name && row.player2 === a.name)
    })
    .setAccessor(function (recs, a, b) {
      if (!recs[0]) return 0;
        return recs[0].player1 === a.name ? +recs[0].pointsTaken : +recs[0].pointsGiven; 
    });
  drawChords(mpr.getMatrix(), mpr.getMap());

//*******************************************************************
      //  DRAW THE CHORD DIAGRAM
      //*******************************************************************
      function drawChords (matrix, mmap) {
        var w = 980, h = 800, r1 = h / 2, r0 = r1 - 110;

        var fill = d3.scale.ordinal()
            .range(['#c7b570','#c6cdc7','#335c64','#768935','#507282','#5c4a56','#aa7455','#574109','#837722','#73342d','#0a5564','#9c8f57','#7895a4','#4a5456','#b0a690','#0a3542',]);

        var chord = d3.layout.chord()
            .padding(.02)
            .sortSubgroups(d3.descending)
            .sortChords(d3.descending);

        var arc = d3.svg.arc()
            .innerRadius(r0)
            .outerRadius(r0 + 20);

        var svg = d3.select("body").append("svg:svg")
            .attr("width", w)
            .attr("height", h)
          .append("svg:g")
            .attr("id", "circle")
            .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")");

            svg.append("circle")
                .attr("r", r0 + 20);

        var rdr = chordRdr(matrix, mmap);
        chord.matrix(matrix);

        var g = svg.selectAll("g.group")
            .data(chord.groups())
          .enter().append("svg:g")
            .attr("class", "group")
            .on("mouseover", mouseover)
            .on("mouseout", function (d) { d3.select("#tooltip").style("visibility", "hidden") });

        g.append("svg:path")
            .style("stroke", "black")
            .style("fill", function(d) { return fill(rdr(d).gname); })
            .attr("d", arc);

        g.append("svg:text")
            .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
            .attr("dy", ".35em")
            .style("font-family", "helvetica, arial, sans-serif")
            .style("font-size", "9px")
            .attr("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
            .attr("transform", function(d) {
              return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
                  + "translate(" + (r0 + 26) + ")"
                  + (d.angle > Math.PI ? "rotate(180)" : "");
            })
            .text(function(d) { return rdr(d).gname; });

          var chordPaths = svg.selectAll("path.chord")
                .data(chord.chords())
              .enter().append("svg:path")
                .attr("class", "chord")
                .style("stroke", function(d) { return d3.rgb(fill(rdr(d).sname)).darker(); })
                .style("fill", function(d) { return fill(rdr(d).sname); })
                .attr("d", d3.svg.chord().radius(r0))
                .on("mouseover", function (d) {
                  d3.select("#tooltip")
                    .style("visibility", "visible")
                    .html(chordTip(rdr(d)))
                    .style("top", function () { return (d3.event.pageY - 170)+"px"})
                    .style("left", function () { return (d3.event.pageX - 100)+"px";})
                })
                .on("mouseout", function (d) { d3.select("#tooltip").style("visibility", "hidden") });

          function chordTip (d) {
            var p = d3.format(".1%"), q = d3.format(",.2f")
            return "Chord Info:<br/>"
              +  d.sname + " took from " + d.tname
              + ": " + q(d.svalue) + " pts<br/>"
              + p(d.svalue/d.stotal) + " of " + d.sname + "'s Total (" + q(d.stotal) + " pts)<br/>"
              + p(d.svalue/d.mtotal) + " of All Points in Elotron (" + q(d.mtotal) + " pts)<br/>"
              + "<br/>"
              + d.tname + " took from " + d.sname
              + ": " + q(d.tvalue) + " pts<br/>"
              + p(d.tvalue/d.ttotal) + " of " + d.tname + "'s Total (" + q(d.ttotal) + " pts)<br/>"
              + p(d.tvalue/d.mtotal) + " of All Points in Elotron (" + q(d.mtotal) + " pts)";
          }

          function groupTip (d) {
            var p = d3.format(".1%"), q = d3.format(",.2f")
            return "" + d.gname + ": " + q(d.gvalue) + " pts<br/>"
                + p(d.gvalue/d.mtotal) + " of All Points in Elotron (" + q(d.mtotal) + " pts)"
          }

          function mouseover(d, i) {
            d3.select("#tooltip")
              .style("visibility", "visible")
              .html(groupTip(rdr(d)))
              .style("top", function () { return (d3.event.pageY - 80)+"px"})
              .style("left", function () { return (d3.event.pageX - 130)+"px";})

            chordPaths.classed("fade", function(p) {
              return p.source.index != i
                  && p.target.index != i;
            });
          }
      }
};
    (function() 
    {
        d3.json("/allstats", allStats);
    })();
</script>
{% endif %}
{% endblock %}
